function setCookie(cname, cvalue, exdays) {
  const d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  let expires = "expires="+ d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(";");
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == " ") {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
function chkMode() {
  if (getCookie("mode") == "0") {
    setCookie("mode", "0", 365);
	document.getElementsByTagName("link")[1].href = "/asset/style-dark.min.css";
  } else {
    setCookie("mode", "1", 365);
  }
}
function def() {
  document.getElementById("main").innerHTML = "<div>>>> <a id='sys-"+num.toString()+"'></a><span>&nbsp;</span></div>";
}
function listen() {
  document.addEventListener("keypress", inp);
  document.addEventListener("keydown", del);
}
function inp(e) {
  if (e.key == "Enter") {
	document.getElementById("sys-"+num.toString()).parentNode.innerHTML = ">>> <a id='sys-"+num.toString()+"'>"+document.getElementById("sys-"+num.toString()).innerHTML+"</a>";
	exc = document.getElementById("sys-"+num.toString()).innerHTML;
	chk(exc);
  } else {
    document.getElementById("sys-"+num.toString()).innerHTML += e.key;
  }
}
function del(e) {
  if (e.key == "Delete" || e.key == "Backspace") {
    document.getElementById("sys-"+num.toString()).innerHTML = document.getElementById("sys-"+num.toString()).innerHTML.slice(0, -1);
  }
}
function chk(exc) {
  if (exc == "help") {
    document.getElementById("main").innerHTML += "<br><div>&nbsp;&nbsp;&nbsp;&nbsp;Type <a class='primary'>set [light|dark]</a> to switch between light and dark theme.</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Type <a class='primary'>query [1|2|...]</a> to check a post.</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Type <a class='primary'>post [messages here...]</a> to send a post.</div><br>";
	num += 1;
	document.getElementById("main").innerHTML += "<div>>>> <a id='sys-"+num.toString()+"'></a><span>&nbsp;</span></div>";
  } else if (exc == "set light") {
    setCookie("mode", "1", 365);
	location.reload();
  } else if (exc == "set dark") {
    setCookie("mode", "0", 365);
	location.reload();
  } else if (exc.startsWith("post ") && exc.substring(5) != "") {
    xhttp.open("POST", "/src/postMsg.php", true);
	xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send("text="+exc.substring(5));
	xhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
	    document.getElementById("main").innerHTML += this.responseText;
		num += 1;
		document.getElementById("main").innerHTML += "<div>>>> <a id='sys-"+num.toString()+"'></a><span>&nbsp;</span></div>";
	  }
	};
  } else if (exc.startsWith("query ") && exc.substring(6) != "") {
    xhttp.open("GET", "/src/queryMsg.php?id="+exc.substring(6), true);
    xhttp.send();
	xhttp.onreadystatechange = function() {
	  if (this.readyState == 4 && this.status == 200) {
	    a = document.createElement("a");
		a.innerText = this.responseText;
		document.getElementById("main").innerHTML += "<br><div>&nbsp;&nbsp;&nbsp;&nbsp;"+a.innerText+"</div><br>";
		num += 1;
		document.getElementById("main").innerHTML += "<div>>>> <a id='sys-"+num.toString()+"'></a><span>&nbsp;</span></div>";
	  }
	};
  } else {
    document.getElementById("main").innerHTML += "<br><div>&nbsp;&nbsp;&nbsp;&nbsp;<a class='err'>Error!</a> Type <a class='primary'>help</a> for further instructions.</div><br>";
	num += 1;
	document.getElementById("main").innerHTML += "<div>>>> <a id='sys-"+num.toString()+"'></a><span>&nbsp;</span></div>";
  }
}
function run() {
  chkMode();
  def();
  listen();
}
var num = 1;
var xhttp = new XMLHttpRequest();
run();